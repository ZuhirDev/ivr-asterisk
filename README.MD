# Sistema IVR Escalable para Gesti칩n de Llamadas

Este proyecto implementa un **IVR modular** utilizando **XState** para manejar m치quinas de estado y **Asterisk ARI** para la gesti칩n de llamadas telef칩nicas.  

El IVR actual est치 dise침ado como un sistema escalable que permite:

- Navegaci칩n entre men칰s de varios departamentos.  
- Control de intentos limitados por men칰.  
- Lectura de DTMF con timeout.  
- Reproducci칩n de audio generado din치micamente con **eSpeak**.  
- Integraci칩n con Asterisk ARI para contestar y colgar llamadas.

---

## 游꿑 M치quina base (`withAttempts`)

La **m치quina base** es el n칰cleo del sistema de men칰s. Su objetivo es:

- Proporcionar un control uniforme de **reintentos** para los men칰s.  
- Definir la l칩gica de **entrada de usuario** y transici칩n de estados.  
- Servir como plantilla para todas las m치quinas de departamento.

La m치quina base permite que cada m치quina de departamento defina sus propios estados y acciones sin tener que replicar la l칩gica de reintentos o de entrada de usuario.

## 游끽 M치quina principal y men칰s de los departamentos

El IVR est치 compuesto por varias m치quinas de estado que representan los men칰s de cada departamento, todas ellas **heredan la l칩gica de la m치quina base**, lo que garantiza control de reintentos, gesti칩n de DTMF y transici칩n segura de estados.

### M치quina principal

La m치quina principal es el punto de entrada del IVR. Cuando un usuario llama, se le da la bienvenida y se le presenta el men칰 de departamentos:

- Para acceder a **Facturaci칩n**, el usuario marca `1`.  
- Para acceder a **RRHH**, el usuario marca `2`.

### Departamento RRHH

En RRHH, el usuario puede elegir entre:

- **N칩mina**:  
  El sistema solicita el DNI (8 d칤gitos) mediante DTMF. A continuaci칩n, se realiza una consulta simulada a un API p칰blico (`getUser`) y se reproduce un mensaje con el nombre del usuario y una n칩mina simulada.

- **Contrataci칩n**:  
  El IVR reproduce un mensaje indicando que la solicitud ser치 atendida y finaliza la llamada.

### Departamento Facturaci칩n

En Facturaci칩n, el usuario puede elegir entre:

- **Consultar facturas**:  
  Simulaci칩n de consulta de facturas mediante logs.  

- **Pagar facturas**:  
  Simulaci칩n de pago de facturas mediante logs.

---

En conjunto, la **m치quina principal** coordina todos los departamentos y asegura que la navegaci칩n sea fluida, segura y consistente, mientras que cada m치quina de departamento mantiene su l칩gica independiente y reutiliza las funcionalidades de la m치quina base.

---

## 游 Gesti칩n de DTMF (`listenDtmf`)

La funci칩n `listenDtmf` permite capturar de manera controlada la entrada del usuario desde el teclado del tel칠fono durante la llamada. Es la forma en que el IVR sabe qu칠 opci칩n ha seleccionado el usuario y permite que las m치quinas de estado reaccionen adecuadamente.

`listenDtmf` permite definir cu치ntos d칤gitos puede marcar el usuario y cu치l car치cter indica que ha terminado de introducir su respuesta, como por ejemplo `#`. Adem치s, controla el tiempo m치ximo de espera para la entrada, de forma que si el usuario no responde dentro del per칤odo definido (por defecto 10 segundos), la llamada se cuelga autom치ticamente.

---

## 游댉 Texto a voz (TTS) con eSpeak

El IVR genera mensajes din치micos usando **eSpeak**:

1. Se env칤a el texto al microservicio eSpeak mediante HTTP POST.  
2. Se genera un archivo de audio (`.wav`) en el servidor.  
3. Se reproduce el audio en la llamada mediante ARI.  
4. Opcionalmente, se puede colgar la llamada al terminar la reproducci칩n.

**Funci칩n principal:**  
- `playTextAudio(channel, text, hangup = false)`

Esto permite reproducir mensajes din치micos en cualquier estado de la m치quina.

## 游 Funcionamiento general del IVR

Cuando llega una llamada:

1. Se responde autom치ticamente usando `answerChannel`.  
2. Se arranca la **m치quina principal**, que representa el men칰 de selecci칩n de departamento.  
3. Seg칰n la opci칩n seleccionada por el usuario (DTMF), se invoca la m치quina correspondiente del departamento.  
4. Cada m치quina de departamento puede ejecutar sub-men칰s, reproducir mensajes, solicitar datos o finalizar la llamada.  
5. Al finalizar una m치quina de departamento, la llamada puede volver al men칰 principal o colgarse autom치ticamente.
